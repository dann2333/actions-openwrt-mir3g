version: 2.1
jobs:
  build-openwrt:
    machine:
      image: ubuntu-2204:current
    environment:
      REPO_URL: https://github.com/dann2333/lede
      REPO_BRANCH: master
      FEEDS_CONF: feeds.conf.default
      CONFIG_FILE: .config
      DIY_P1_SH: diy-part1.sh
      DIY_P2_SH: diy-part2.sh
      TZ: Asia/Shanghai
    resource_class: large
    steps:
      - run:
          name: Prepare for checkout
          command: |
            mkdir github
      - checkout:
          path: github/
      - run: 
          command: |
           export DEBIAN_FRONTEND=noninteractive
           sudo -E apt-get -q update
           sudo -E apt-get -qy install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
           sudo -E apt-get -qy autoremove --purge
           sudo -E apt-get -q clean
           sudo timedatectl set-timezone "$TZ"
           sudo mkdir -p /workdir
           sudo chown $USER:$GROUPS /workdir
          name: Initialization environment
      - run:
          name: Clone source code
          command: |
           git clone $REPO_URL -b $REPO_BRANCH openwrt
           cd openwrt
           rm -rf ./tmp && rm -rf .config
           cd ..
           cp github/.config openwrt/.config
           cp github/diy-part1.sh openwrt/diy-part1.sh
           cp github/diy-part2.sh openwrt/diy-part2.sh
           cd openwrt
           
      - store_artifacts:
          path: openwrt/.config
          
      - run:
          name: Apply custom feeds and scripts
          command: |
           cd openwrt
           bash diy-part1.sh
           ./scripts/feeds update -a
           ./scripts/feeds install -a
           bash diy-part2.sh
           make defconfig
      - run:
          name: make
          command: |
           cd openwrt
           make download -j8
           make V=s -j$(nproc)
           
      - run:
          name: prepare to upload firmware
          command: |
           cd openwrt/bin/targets/*/*
           rm -rf packages
            
      - store_artifacts:
          path: openwrt/bin/targets
           

workflows:
  # Name of workflow
  make:
    # List of jobs that will run
    jobs:
      - build-openwrt
